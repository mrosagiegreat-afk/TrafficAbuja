<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Dashboard | TrafficAbuja</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset & Base - FIXED for mobile */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        html {
            font-size: 16px;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.5;
            color: #1a1a1a;
            background: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 0;
        }

        .top-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .logo-container {
            flex-shrink: 0;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            color: #1a1a1a;
            text-decoration: none;
            letter-spacing: -0.5px;
            white-space: nowrap;
            padding: 8px 0;
            display: inline-block;
        }

        .logo sup {
            font-size: 9px;
            vertical-align: super;
            color: #888;
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            min-width: 200px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 45px 10px 20px;
            border: 1px solid #e0e0e0;
            border-radius: 50px;
            font-size: 14px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            background: #fff;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
        }

        .search-bar i {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .profile-btn {
            background: none;
            border: none;
            font-size: 22px;
            color: #1a1a1a;
            cursor: pointer;
            padding: 8px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .profile-btn:hover {
            background: #f8f9fa;
            color: #000;
        }

        /* Main Layout */
        .dashboard-container {
            display: flex;
            flex: 1;
            margin-top: 70px;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            padding: 30px 0;
            position: fixed;
            left: 0;
            top: 70px;
            bottom: 0;
            z-index: 100;
        }

        /* Gratuity Section - NEW */
        .gratuity-section {
            padding: 0 30px 25px 30px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 25px;
        }

        .gratuity-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .gratuity-title i {
            color: #4CAF50;
            font-size: 16px;
        }

        .gratuity-amounts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .amount-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .amount-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .amount-card.naira {
            border-color: #4CAF50;
            background: #f0f9f0;
        }

        .amount-card.dollar {
            border-color: #2196F3;
            background: #f0f8ff;
        }

        .currency {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .amount {
            font-size: 28px;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .amount.naira {
            color: #4CAF50;
        }

        .amount.dollar {
            color: #2196F3;
        }

        .amount-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Notify Us Button */
        .notify-btn {
            width: 100%;
            padding: 14px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .notify-btn:hover:not(:disabled) {
            background: #333;
            transform: translateY(-2px);
        }

        .notify-btn:disabled {
            background: #e0e0e0;
            color: #888;
            cursor: not-allowed;
        }

        .sidebar-header {
            padding: 0 30px 25px 30px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 25px;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .member-since {
            font-size: 13px;
            color: #888;
            font-style: italic;
        }

        .events-list {
            padding: 0 20px;
        }

        .event-item {
            padding: 20px;
            border-bottom: 1px solid #e8e8e8;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .event-item:hover {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .event-item.active {
            background: #fff;
            border-left: 4px solid #1a1a1a;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .event-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .event-time {
            font-size: 14px;
            color: #666;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 320px;
            padding: 40px;
            background: #fff;
            overflow-y: auto;
        }

        /* Event Detail */
        .event-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e8e8e8;
        }

        .event-icon {
            width: 50px;
            height: 50px;
            background: #f8f9fa;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
        }

        .event-icon i {
            font-size: 22px;
            color: #1a1a1a;
        }

        .event-info h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .event-date {
            font-size: 16px;
            color: #666;
        }

        /* Event Requirements Section - NEW */
        .requirements-section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
        }

        .requirements-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #1a1a1a;
            position: relative;
            padding-bottom: 10px;
        }

        .requirements-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 50px;
            height: 3px;
            background: #1a1a1a;
            border-radius: 2px;
        }

        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .requirement-icon {
            width: 40px;
            height: 40px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .requirement-icon i {
            font-size: 18px;
            color: #666;
        }

        .requirement-info h4 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .requirement-info p {
            font-size: 13px;
            color: #666;
        }

        .requirement-status {
            margin-left: auto;
            flex-shrink: 0;
        }

        .status-check {
            width: 24px;
            height: 24px;
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .status-pending {
            width: 24px;
            height: 24px;
            background: #ff9800;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Address Section */
        .address-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 40px;
            border-radius: 16px;
            margin: 40px 0;
            border: 1px solid #e8e8e8;
        }

        .address-label {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .address-text {
            font-size: 42px;
            font-weight: 800;
            line-height: 1.2;
            color: #1a1a1a;
            letter-spacing: -0.5px;
        }

        /* Status Section */
        .status-section {
            margin: 50px 0;
        }

        .status-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #1a1a1a;
            position: relative;
            padding-bottom: 10px;
        }

        .status-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 50px;
            height: 3px;
            background: #1a1a1a;
            border-radius: 2px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e8e8e8;
        }

        .status-label {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
        }

        /* Profile Panel */
        .profile-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: #fff;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .profile-panel.active {
            right: 0;
        }

        .profile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .profile-overlay.active {
            display: block;
        }

        .profile-header {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e8e8e8;
        }

        .profile-title-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .profile-title {
            font-size: 22px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .close-profile {
            background: #f8f9fa;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .close-profile:hover {
            background: #1a1a1a;
            color: white;
        }

        .profile-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .member-since-profile {
            font-size: 13px;
            color: #888;
            font-style: italic;
        }

        /* Profile Item Improvements */
        .profile-item {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #f0f0f0;
        }

        .profile-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .profile-label {
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .profile-label::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 4px;
            background: #1a1a1a;
            border-radius: 50%;
            margin-right: 8px;
        }

        .profile-value {
            font-size: 16px;
            color: #1a1a1a;
            font-weight: 500;
            line-height: 1.5;
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a1a1a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            text-align: center;
            padding: 40px;
        }

        .empty-state i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 22px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #888;
            max-width: 400px;
            line-height: 1.6;
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #dc2626;
        }

        .error-state i {
            font-size: 48px;
            margin-bottom: 20px;
        }

        /* Success Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Logout button responsive adjustments */
@media (max-width: 768px) {
    #logoutBtn {
        padding: 14px 20px;
        font-size: 17px;
    }
    
    /* NEW: Mobile layout fix - show either events list OR event details */
    .dashboard-container {
        flex-direction: column;
        height: calc(100vh - 70px); /* ADDED THIS LINE */
    }
    
    .sidebar {
        position: static;
        width: 100%;
        height: 50%; /* CHANGED from "height: auto" */
        max-height: 50%; /* ADDED THIS LINE */
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        overflow-y: auto; /* ADDED THIS LINE */
    }
    
    .main-content {
        margin-left: 0;
        height: 50%; /* ADDED THIS LINE */
        max-height: 50%; /* ADDED THIS LINE */
        padding: 25px;
        overflow-y: auto; /* ADDED THIS LINE */
        position: relative; /* ADDED THIS LINE */
    }
    
    /* ADD THESE NEW RULES: */
    /* Hide empty state initially */
    .empty-state {
        display: none;
    }
    
    /* Show empty state when no event is selected (on mobile) */
    .main-content:not(.event-selected) .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    /* Hide event details when no event is selected */
    .main-content:not(.event-selected) > *:not(.empty-state) {
        display: none;
    }
    
    /* Add back button for mobile when viewing event details */
    .back-to-events {
        display: none; /* Hidden by default */
    }
    
    /* Show back button on mobile when event is selected */
    .main-content.event-selected .back-to-events {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding: 10px 15px;
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        color: #1a1a1a;
    }
    
    .back-to-events i {
        font-size: 14px;
    }
    
    /* Adjust spacing for mobile */
    .gratuity-section {
        padding: 0 20px 20px 20px;
    }
    
    .sidebar-header {
        padding: 0 20px 20px 20px;
    }
    
    .events-list {
        padding: 0 15px;
    }
    /* END OF NEW RULES */
    
    /* YOUR EXISTING 768px MEDIA QUERY CODE SHOULD COME HERE */
    .top-bar-content {
        flex-wrap: wrap;
        padding: 0 15px;
        gap: 15px;
    }
    
    .search-bar {
        order: 3;
        max-width: 100%;
        margin: 15px 0 0 0;
    }
    
    .address-text {
        font-size: 28px;
    }
    
    .profile-panel {
        width: 100%;
        right: -100%;
        padding: 25px 20px;
    }
    
    .profile-header {
        flex-direction: row;
        align-items: flex-start;
        margin-bottom: 25px;
    }
    
    .close-profile {
        position: absolute;
        top: 25px;
        right: 20px;
    }
    
    .logo {
        font-size: 20px;
    }
    
    .amount {
        font-size: 22px;
    }
    
    .requirements-grid {
        grid-template-columns: 1fr;
    }
} /* <-- THIS IS THE CORRECT CLOSING BRACE FOR THE 768px MEDIA QUERY */

@media (max-width: 480px) {
    #logoutBtn {
        padding: 16px 20px;
    }
    
    /* ADD THESE LINES TO THE 480px BLOCK: */
    .main-content {
        padding: 20px;
        height: 55%; /* ADD THIS */
        max-height: 55%; /* ADD THIS */
    }
    
    .sidebar {
        height: 45%; /* ADD THIS */
        max-height: 45%; /* ADD THIS */
    }
    /* END OF ADDED LINES */
    
    .event-info h1 {
        font-size: 24px;
    }
    
    .address-section {
        padding: 25px;
    }
    
    .address-text {
        font-size: 20px; /* CHANGED from 24px to 20px */
    }
    
    .status-grid {
        grid-template-columns: 1fr;
    }
    
    .logo {
        font-size: 18px;
    }
    
    .profile-btn {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
    
    .profile-panel {
        padding: 20px 15px;
    }
    
    .profile-title {
        font-size: 20px;
    }
    
    .amount-card {
        padding: 15px;
    }
    
    .amount {
        font-size: 20px;
    }
    
    /* ADD THESE LINES: */
    .requirements-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .requirement-item {
        padding: 12px;
    }
    /* END OF ADDED LINES */
}  /* <-- THIS CLOSES THE 480px MEDIA QUERY */

    </style>
</head>
<body>    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-content">
            <div class="logo-container">
                <a href="index.html" class="logo">TrafficAbuja<sup>Â®</sup></a>
            </div>
            
            <div class="search-bar">
                <input type="text" placeholder="Search events..." id="searchInput">
                <i class="fas fa-search"></i>
            </div>
            
            <button class="profile-btn" id="profileBtn" aria-label="Open profile">
                <i class="fas fa-user-circle"></i>
            </button>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Gratuity Section - NEW -->
            <div class="gratuity-section">
                <div class="gratuity-title">
                    <span>GRATUITY EARNED</span>
                    <i class="fas fa-coins"></i>
                </div>
                
                <div class="gratuity-amounts">
                    <div class="amount-card naira">
                        <div class="currency">NAIRA</div>
                        <div class="amount naira" id="nairaAmount">â‚¦0</div>
                        <div class="amount-label">Total Earned</div>
                    </div>
                    
                    <div class="amount-card dollar">
                        <div class="currency">DOLLAR</div>
                        <div class="amount dollar" id="dollarAmount">$0</div>
                        <div class="amount-label">Total Earned</div>
                    </div>
                </div>
                
                <button class="notify-btn" id="notifyBtn" disabled>
                    <i class="fas fa-bell"></i>
                    <span>Notify Us (15 appearances needed)</span>
                </button>
            </div>
            
            <div class="sidebar-header">
    <h3 class="sidebar-title">WELCOME</h3>
    <p class="sidebar-subtitle">â€¢ Click an event for details<br>â€¢ Access information via the profile icon<br>â€¢ To log out, access the option in profile view.</p>
    <div class="member-since" id="memberSince">Member since: Loading...</div>
    <!-- ADD THIS VERIFIED BADGE ELEMENT -->
    <div id="verifiedBadge" style="display: none; margin-top: 15px; padding: 10px; background: #f0f9f0; border: 1px solid #c8e6c9; border-radius: 8px;">
        <span style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2e7d32;">
            <i class="fas fa-check-circle"></i>
            <span>Verified Account</span>
        </span>
        <p style="font-size: 12px; color: #558b2f; margin-top: 5px; margin-left: 24px;">
            This account has been verified by TrafficAbuja
        </p>
    </div>
</div>            
            <div class="events-list" id="eventsList">
                <!-- Events will be loaded here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Event details will be loaded here -->
            <div class="empty-state" id="emptyState">
                <i class="fas fa-calendar-alt"></i>
                <h3>No Event Selected</h3>
                <p>Select an event from the sidebar to view its details, including location, timing, and client feedback.</p>
            </div>
        </div>
    </div>

    <!-- Profile Panel -->
<div class="profile-panel" id="profilePanel"> <!-- ADD THIS OPENING DIV -->
    <div class="profile-header">
        <div class="profile-title-row">
            <div>
                <h2 class="profile-title" id="userGreeting">HI, ðŸ‘‹</h2>
                <!-- Add this verified badge element -->
                <!-- Minimalist Meta-style badge for profile panel -->
<div id="profileVerifiedBadge" style="display: none; margin: 10px 0;">
    <span style="display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #1877F2 0%, #1D4ED8 100%); color: white; padding: 6px 12px 6px 8px; border-radius: 20px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(24, 119, 242, 0.3);">
        <span style="background: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-check" style="color: #1877F2; font-size: 10px; font-weight: bold;"></i>
        </span>
        <span>Verified</span>
    </span>
</div>
                <p class="profile-subtitle">Contact TrafficAbuja to update your information.</p>
                <div class="member-since-profile" id="profileMemberSince">Member since: Loading...</div>
            </div>
            <button class="close-profile" id="closeProfile">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <div class="profile-section">
        <div class="profile-item">
            <div class="profile-label">Name</div>
            <div class="profile-value" id="profileName">Loading...</div>
        </div>
        
        <div class="profile-item">
            <div class="profile-label">Phone Number</div>
            <div class="profile-value" id="profilePhone">Loading...</div>
        </div>
        
        <div class="profile-item">
            <div class="profile-label">Address</div>
            <div class="profile-value" id="profileAddress">Loading...</div>
        </div>
        
        <div class="profile-item">
            <div class="profile-label">Education</div>
            <div class="profile-value" id="profileEducation">Loading...</div>
        </div>
        
        <div class="profile-item">
            <div class="profile-label">Beneficiary</div>
            <div class="profile-value" id="profileBeneficiary">
                Loading...
            </div>
        </div>
        
        <div class="profile-item">
            <div class="profile-label">Account Details</div>
            <div class="profile-value" id="profileAccount">
                Loading...
            </div>
        </div>
        
        <div class="profile-item">
            <div class="profile-label">Appearances</div>
            <div class="profile-value" id="profileAppearances">
                Loading...
            </div>
        </div>
        
        <!-- Logout Button Section -->
        <div class="profile-item">
            <div class="profile-label">Account</div>
            <div class="profile-value">
                <button id="logoutBtn" style="
                    width: 100%;
                    padding: 12px 20px;
                    background: #1a1a1a;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    margin-top: 10px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                ">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
                <p style="font-size: 14px; color: #666; margin-top: 15px; text-align: center;">
                    You'll be redirected to the main page
                </p>
            </div>
        </div>
    </div>
</div> <!-- CLOSE THE PROFILE PANEL DIV -->

    <!-- Profile Overlay -->
    <div class="profile-overlay" id="profileOverlay"></div>

    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://qoisqrzlfspzxtnkgyyr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvaXNxcnpsZnNwenh0bmtneXlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDA0MzMsImV4cCI6MjA4MjM3NjQzM30.jp97VkUx6IFARFzFw3YXJJfBZmdnnCPHM95Q1WAqHnc';

        // Telegram Bot Configuration (You'll add your own credentials)
// Telegram Bot Configuration
const TELEGRAM_BOT_TOKEN = '8550670648:AAFY4SNAi-lXD756cz7SOowhbaeIIpLeYWY';
const TELEGRAM_CHAT_ID = '8565420381'; // Confirmed Human ID

        // Initialize Supabase client
        let supabaseClient;

        if (typeof window.supabase !== 'undefined') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            const script = document.querySelector('script[src*="supabase-js"]');
            script.addEventListener('load', () => {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                if (typeof initApp === 'function') initApp();
            });
        }

        // Check authentication
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('affiliate_logged_in') !== 'true') {
                window.location.href = 'affiliatelogin.html';
                return;
            }
            
            loadAffiliateData();
            
            // iOS Zoom Fix
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.style.fontSize = '16px';
            });
        });

        // DOM Elements
        const eventsList = document.getElementById('eventsList');
        const mainContent = document.getElementById('mainContent');
        const emptyState = document.getElementById('emptyState');
        const profileBtn = document.getElementById('profileBtn');
        const profilePanel = document.getElementById('profilePanel');
        const profileOverlay = document.getElementById('profileOverlay');
        const closeProfile = document.getElementById('closeProfile');
        const notifyBtn = document.getElementById('notifyBtn');
        const nairaAmount = document.getElementById('nairaAmount');
        const dollarAmount = document.getElementById('dollarAmount');
        const memberSince = document.getElementById('memberSince');
        const profileMemberSince = document.getElementById('profileMemberSince');
        // Add this to your list of DOM Elements
const userGreeting = document.getElementById('userGreeting');

        // Load affiliate data from Supabase
        async function loadAffiliateData() {
            try {
                // 1. Get the Login ID from localStorage
                const userLoginId = localStorage.getItem('affiliate_user_id');
                
                if (!userLoginId) {
                    window.location.href = 'affiliatelogin.html';
                    return;
                }

                // 2. Fetch profile
                const { data: affiliate, error: profileError } = await supabaseClient
                    .from('affiliates')
                    .select('*')
                    .eq('user_id', userLoginId)
                    .single();
                
                if (profileError) throw profileError;

                // 3. Fetch events for this affiliate
                const { data: events, error: eventsError } = await supabaseClient
                    .from('events')
                    .select('*')
                    .eq('affiliate_id', affiliate.id)
                    .order('date', { ascending: false });

                if (eventsError) throw eventsError;

                // 4. Update the UI
                updateGratuitySection(affiliate);
                updateProfilePanel(affiliate);
                loadEvents(events || []);
                
                // 5. Update member since
                if (affiliate.created_at) {
                    const createdDate = new Date(affiliate.created_at);
                    const formattedDate = createdDate.toLocaleDateString('en-US', {
                        month: 'long',
                        year: 'numeric'
                    });
                    memberSince.textContent = `Member since: ${formattedDate}`;
                    profileMemberSince.textContent = `Member since: ${formattedDate}`;
                }
                
                // 6. Select first event if available
                if (events && events.length > 0) {
                    showEventDetails(events[0]);
                    const firstEventElement = document.querySelector('.event-item');
                    if (firstEventElement) firstEventElement.classList.add('active');
                }
                
            } catch (error) {
                console.error('Detailed Error Context:', error);
                showErrorState();
            }
        }

        // Update Gratuity Section
function updateGratuitySection(affiliate) {
    // 1. Update Amount Displays
    const nairaGratuity = affiliate.naira_gratuity || 'â‚¦0';
    const dollarGratuity = affiliate.dollar_gratuity || '$0';
    nairaAmount.textContent = nairaGratuity;
    dollarAmount.textContent = dollarGratuity;
    
    // 2. Calculate Appearances
    const appearancesStr = affiliate.appearances || '0 off 0';
    const [completed] = appearancesStr.split(' off ').map(Number);
    
    // 3. Logic: Is it exactly a milestone (15, 30, 45...)?
    const isMilestone = completed > 0 && completed % 15 === 0;
    
    // 4. Logic: Have we already sent a notification for THIS count?
    const lastNotified = parseInt(localStorage.getItem('last_notification_milestone') || '0');
    const alreadySent = completed <= lastNotified;

    if (isMilestone && !alreadySent) {
        // ENABLE: Exactly a milestone and hasn't been sent yet
        notifyBtn.disabled = false;
        notifyBtn.style.opacity = "1";
        notifyBtn.innerHTML = '<i class="fas fa-bell"></i><span>Notify Us for Tip-out!</span>';
        notifyBtn.onclick = () => sendNotification(affiliate, completed);
    } else if (isMilestone && alreadySent) {
        // DISABLE: Milestone reached but already clicked
        notifyBtn.disabled = true;
        notifyBtn.style.opacity = "0.5";
        notifyBtn.innerHTML = '<i class="fas fa-check-circle"></i><span>Notification Sent!</span>';
    } else {
        // DISABLE: Not a multiple of 15 (e.g., 14, 16, 29, 31)
        const nextGoal = Math.ceil((completed + 1) / 15) * 15;
        const remaining = nextGoal - completed;
        notifyBtn.disabled = true;
        notifyBtn.style.opacity = "0.5";
        notifyBtn.innerHTML = `<i class="fas fa-lock"></i><span>${remaining} more needed for tip-out</span>`;
    }
}

      async function sendNotification(affiliate, appearances) {
    try {
        notifyBtn.disabled = true;
        notifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Sending...</span>';
        
        // Construct the HTML message
        const message = `<b>ðŸš€ NEW GRATUITY CLAIM</b>\n` +
                      `--------------------------\n` +
                      `<b>ðŸ‘¤ Affiliate:</b> ${affiliate.name}\n` +
                      `<b>ðŸ†” ID:</b> <code>${affiliate.user_id}</code>\n` +
                      `<b>ðŸ“ž Phone:</b> ${affiliate.phone}\n` +
                      `<b>âœ… Milestone:</b> ${appearances} Appearances\n` +
                      `--------------------------\n` +
                      `ðŸ•’ <i>Please process this request in the Admin Panel.</i>`;

        // 1. Send to Telegram
        await sendTelegramMessage(message);
        
        // 2. FIX THIS LINE: Use supabaseClient instead of supabase
        const { error: updateError } = await supabaseClient  // CHANGE: supabaseClient not supabase
            .from('affiliates')
            .update({ last_notified_milestone: appearances })
            .eq('user_id', affiliate.user_id);

        if (updateError) console.error('Supabase error:', updateError);

        // 3. Save to browser as backup
        localStorage.setItem('last_notification_milestone', appearances);
        localStorage.setItem('last_notification_date', new Date().toLocaleDateString());
        
        // 4. REFRESH THE UI (Locks the button immediately)
        // We update the local affiliate object so the button knows to change
        affiliate.last_notified_milestone = appearances;
        updateGratuitySection(affiliate);
        
        showNotification('Notification sent! Admin has been alerted.');
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error sending message: ' + error.message, true);
        notifyBtn.disabled = false;
        notifyBtn.innerHTML = '<i class="fas fa-bell"></i><span>Try Again</span>';
    }
}

        async function sendTelegramMessage(message) {
    // Uses the global variables you defined at the top of your script
    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: message,
            parse_mode: 'HTML' // Changed from Markdown to HTML
        })
    });
    
    if (!response.ok) {
        const errorData = await response.json();
        console.error('Telegram API Error Details:', errorData); // Logs the exact reason for the 400 error
        throw new Error(errorData.description || 'Telegram API error');
    }
    
    return await response.json();
}

        // Show notification
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = isError ? '#dc2626' : '#4CAF50';
            notification.innerHTML = `
                <i class="fas fa-${isError ? 'exclamation-circle' : 'check-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Load events in sidebar
        function loadEvents(events) {
            const eventsList = document.getElementById('eventsList');
            if (!eventsList) return;
            
            eventsList.innerHTML = '';
            
            if (!events || events.length === 0) {
                eventsList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-calendar-times" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <p>No completed events yet</p>
                    </div>
                `;
                return;
            }

            events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'event-item';
                eventElement.dataset.id = event.id;
                
                const eventDate = new Date(event.date);
                const timeAgo = getTimeAgo(eventDate);
                
                eventElement.innerHTML = `
                    <div class="event-title">${event.title || 'Untitled Event'}</div>
                    <div class="event-time">Completed ${timeAgo}</div>
                `;
                
                eventElement.addEventListener('click', () => showEventDetails(event));
                eventsList.appendChild(eventElement);
            });
        }

        // Show event details in main content
        function showEventDetails(event) {
            emptyState.style.display = 'none';
            
            // Format dates
            const eventDate = new Date(event.date);
            const formattedDate = eventDate.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const formattedTime = event.time ? event.time.substring(0, 5) : '--:--';
            const timeArrived = event.time_arrived ? event.time_arrived.substring(0, 5) : '--:--';
            const timeLeft = event.time_left ? event.time_left.substring(0, 5) : '--:--';
            
            // Check event requirements status
            const requirements = {
                photoCheckIn: event.photo_checkin || false,
                videos: event.videos || false,
                liveVideo: event.live_video || false,
                postEventReport: event.post_event_report || false
            };
            
            mainContent.innerHTML = `
                <div class="event-header">
                    <div class="event-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="event-info">
                        <h1>${event.title}</h1>
                        <div class="event-date">${formattedDate} â€¢ ${formattedTime}</div>
                    </div>
                </div>
                
                <div class="address-section">
                    <div class="address-label">Location</div>
                    <div class="address-text">${event.address}</div>
                </div>
                
                <div class="requirements-section">
                    <h3 class="requirements-title">Event Requirements</h3>
                    <div class="requirements-grid">
                        <div class="requirement-item">
                            <div class="requirement-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="requirement-info">
                                <h4>Photo Check-in</h4>
                                <p>Upload event photos</p>
                            </div>
                            <div class="requirement-status">
                                ${requirements.photoCheckIn ? 
                                    '<div class="status-check"><i class="fas fa-check"></i></div>' : 
                                    '<div class="status-pending"><i class="fas fa-clock"></i></div>'}
                            </div>
                        </div>
                        
                        <div class="requirement-item">
                            <div class="requirement-icon">
                                <i class="fas fa-video"></i>
                            </div>
                            <div class="requirement-info">
                                <h4>Videos</h4>
                                <p>Submit event videos</p>
                            </div>
                            <div class="requirement-status">
                                ${requirements.videos ? 
                                    '<div class="status-check"><i class="fas fa-check"></i></div>' : 
                                    '<div class="status-pending"><i class="fas fa-clock"></i></div>'}
                            </div>
                        </div>
                        
                        <div class="requirement-item">
                            <div class="requirement-icon">
                                <i class="fas fa-broadcast-tower"></i>
                            </div>
                            <div class="requirement-info">
                                <h4>Live Video</h4>
                                <p>Record live session</p>
                            </div>
                            <div class="requirement-status">
                                ${requirements.liveVideo ? 
                                    '<div class="status-check"><i class="fas fa-check"></i></div>' : 
                                    '<div class="status-pending"><i class="fas fa-clock"></i></div>'}
                            </div>
                        </div>
                        
                        <div class="requirement-item">
                            <div class="requirement-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="requirement-info">
                                <h4>Post-event Report</h4>
                                <p>Submit detailed report</p>
                            </div>
                            <div class="requirement-status">
                                ${requirements.postEventReport ? 
                                    '<div class="status-check"><i class="fas fa-check"></i></div>' : 
                                    '<div class="status-pending"><i class="fas fa-clock"></i></div>'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="status-section">
                    <h3 class="status-title">Status</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">Time Arrived</div>
                            <div class="status-value">${timeArrived}</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Time Left</div>
                            <div class="status-value">${timeLeft}</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Review from Client</div>
                            <div class="status-value">"${event.review || 'No review yet'}"</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Update active state in sidebar
            document.querySelectorAll('.event-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.event-item[data-id="${event.id}"]`)?.classList.add('active');
        }

        
        
// Debug function to check verification
function debugVerification(affiliate) {
    console.log('=== DEBUG VERIFICATION ===');
    console.log('Affiliate ID:', affiliate.id);
    console.log('Affiliate Name:', affiliate.name);
    console.log('is_verified value:', affiliate.is_verified);
    console.log('Type of is_verified:', typeof affiliate.is_verified);
    console.log('Boolean check:', affiliate.is_verified === true);
    console.log('String check:', affiliate.is_verified === 'true');
    console.log('Truthy check:', !!affiliate.is_verified);
    console.log('==========================');
}

// Then update your updateProfilePanel function:
function updateProfilePanel(affiliate) {
    // DEBUG: Check verification status
    debugVerification(affiliate);
    
    // 1. Update greeting with name
    const firstName = affiliate.name ? affiliate.name.split(' ')[0].toUpperCase() : 'USER';
    document.getElementById('userGreeting').textContent = `HI, ${firstName} ðŸ‘‹`;
    
    // 2. Show/hide verified badges - with better checking
    const verifiedBadge = document.getElementById('verifiedBadge');
    const profileVerifiedBadge = document.getElementById('profileVerifiedBadge');
    
    console.log('Found verifiedBadge element?', !!verifiedBadge);
    console.log('Found profileVerifiedBadge element?', !!profileVerifiedBadge);
    
    // Check multiple ways is_verified could be stored
    let isVerified = false;
    
    if (affiliate.is_verified === true) {
        isVerified = true;
    } else if (affiliate.is_verified === 'true') {
        isVerified = true;
    } else if (affiliate.is_verified === 1) {
        isVerified = true;
    } else if (affiliate.is_verified === '1') {
        isVerified = true;
    }
    
    console.log('Final isVerified determination:', isVerified);
    
    if (isVerified) {
        console.log('SHOWING verified badges');
        if (verifiedBadge) {
            verifiedBadge.style.display = 'block';
            console.log('Sidebar badge shown');
        }
        if (profileVerifiedBadge) {
            profileVerifiedBadge.style.display = 'block';
            console.log('Profile panel badge shown');
        }
    } else {
        console.log('HIDING verified badges');
        if (verifiedBadge) verifiedBadge.style.display = 'none';
        if (profileVerifiedBadge) profileVerifiedBadge.style.display = 'none';
    }
    
    // Update Basic Profile Fields
    document.getElementById('profileName').textContent = affiliate.name || 'Not set';
    document.getElementById('profilePhone').textContent = affiliate.phone || 'Not set';
    document.getElementById('profileAddress').textContent = affiliate.address || 'Not set';
    document.getElementById('profileEducation').textContent = affiliate.education || 'Not set';
    
    // Update Beneficiaries List
    const beneficiaryElement = document.getElementById('profileBeneficiary');
    let beneficiaries = [];
    
    try {
        if (affiliate.beneficiaries) {
            if (typeof affiliate.beneficiaries === 'string') {
                beneficiaries = JSON.parse(affiliate.beneficiaries);
                if (typeof beneficiaries === 'string') {
                    beneficiaries = JSON.parse(beneficiaries);
                }
            } else if (Array.isArray(affiliate.beneficiaries)) {
                beneficiaries = affiliate.beneficiaries;
            }
        }
    } catch (e) {
        console.error("Error parsing beneficiaries:", e);
    }
    
    if (beneficiaryElement) {
        if (beneficiaries.length === 0) {
            beneficiaryElement.innerHTML = '<div style="color: #666; padding: 10px;">No beneficiaries set</div>';
        } else {
            beneficiaryElement.innerHTML = beneficiaries.map((ben, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; ${index < beneficiaries.length - 1 ? 'border-bottom: 1px solid #f0f0f0;' : ''}">
                    <div>
                        <div style="font-weight: 600; color: #1a1a1a; font-size: 16px;">${ben.name || 'Not set'}</div>
                        <div style="font-size: 14px; color: #666; margin-top: 4px;">${ben.phone || 'Not set'}</div>
                    </div>
                    <span style="background: ${index === 0 ? '#e8f5e9' : '#f8f9fa'}; 
                            color: ${index === 0 ? '#4caf50' : '#666'};
                            padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                        ${index === 0 ? 'Primary' : 'Secondary'}
                    </span>
                </div>
            `).join('');
        }
    }
    
    // Update Account Details
    const accountElement = document.getElementById('profileAccount');
    if (accountElement) {
        accountElement.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 4px;">Bank Details</div>
                    <div style="font-weight: 600; color: #1a1a1a; font-size: 16px;">${affiliate.account_details || 'Not provided'}</div>
                </div>
                <i class="fas fa-bank" style="color: #666; font-size: 20px;"></i>
            </div>
        `;
    }
    
    // Update appearances
    const appearances = affiliate.appearances || '100 off 100';
    const [completed, total] = appearances.split(' off ').map(Number);
    const requestRate = affiliate.request_rate || 0;

    document.getElementById('profileAppearances').innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px;">
            <div>
                <div style="font-size: 32px; font-weight: 800; color: #1a1a1a; line-height: 1;">${completed || 0}</div>
                <div style="font-size: 14px; color: #666; margin-top: 4px;">Events completed</div>
            </div>
            <div style="width: 60px; height: 60px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-check-circle" style="font-size: 24px; color: #4caf50;"></i>
            </div>
        </div>
        
        <div style="padding-top: 20px; border-top: 1px solid #f0f0f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="color: #666; font-size: 14px;">Request Rate</span>
                <span style="font-weight: 600; color: #1a1a1a; font-size: 16px;">${requestRate}%</span>
            </div>
            <div style="height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                <div style="width: ${requestRate}%; height: 100%; background: #4caf50; border-radius: 3px;"></div>
            </div>
        </div>
    `;
}

        // Helper function to get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'today';
            if (diffDays === 1) return 'yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return `${Math.floor(diffDays / 30)} months ago`;
        }

        // Show error state
        function showErrorState() {
            emptyState.innerHTML = `
                <i class="fas fa-exclamation-circle" style="color: #dc2626; font-size: 60px; margin-bottom: 20px;"></i>
                <h3>Connection Error</h3>
                <p>Unable to load your data. Please try again later.</p>
                <button style="margin-top: 20px; padding: 12px 24px; background: #1a1a1a; color: white; border: none; border-radius: 8px; cursor: pointer;" onclick="location.reload()">
                    Retry
                </button>
            `;
            emptyState.style.display = 'flex';
        }

        // Profile panel toggle
        profileBtn.addEventListener('click', () => {
            profilePanel.classList.add('active');
            profileOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        closeProfile.addEventListener('click', () => {
            profilePanel.classList.remove('active');
            profileOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        });

        profileOverlay.addEventListener('click', () => {
            profilePanel.classList.remove('active');
            profileOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        });

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                // Filter events in sidebar
                const eventItems = document.querySelectorAll('.event-item');
                eventItems.forEach(item => {
                    const title = item.querySelector('.event-title').textContent.toLowerCase();
                    if (title.includes(query.toLowerCase())) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('affiliate_logged_in');
            localStorage.removeItem('affiliate_user_id');
            localStorage.removeItem('affiliate_login_time');
            localStorage.removeItem('last_notification_milestone');
            
            sessionStorage.clear();
            
            profilePanel.classList.remove('active');
            profileOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 300);
        });

        // Auto-hide profile on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                profilePanel.classList.remove('active');
                profileOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        });

        // Logout after 30 minutes of inactivity
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                localStorage.removeItem('affiliate_logged_in');
                localStorage.removeItem('affiliate_id');
                localStorage.removeItem('affiliate_user_id');
                localStorage.removeItem('affiliate_name');
                localStorage.removeItem('affiliate_login_time');
                localStorage.removeItem('last_notification_milestone');
                window.location.href = 'affiliatelogin.html';
            }, 30 * 60 * 1000);
        }

        // Reset timer on user activity
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);
        resetInactivityTimer();

        // ============ ADD THIS NEW CODE HERE ============
        // Mobile navigation for events
        function setupMobileNavigation() {
            const mainContent = document.getElementById('mainContent');
            const isMobile = window.innerWidth <= 768;
            
            if (!isMobile) return;
            
            // Add back button to event details
            const originalShowEventDetails = window.showEventDetails;
            if (originalShowEventDetails) {
                window.showEventDetails = function(event) {
                    // Call original function
                    originalShowEventDetails(event);
                    
                    // ADD THIS: Insert back button at the top of mainContent
                    const backButton = `
                        <div class="back-to-events" id="backToEvents">
                            <i class="fas fa-arrow-left"></i>
                            Back to Events
                        </div>
                    `;
                    
                    // Insert back button at the beginning
                    const firstChild = mainContent.firstChild;
                    if (firstChild) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = backButton;
                        mainContent.insertBefore(tempDiv.firstChild, firstChild);
                    } else {
                        mainContent.innerHTML = backButton + mainContent.innerHTML;
                    }
                    
                    mainContent.classList.add('event-selected');
                    emptyState.style.display = 'none';
                    
                    // Add click handler for back button
                    setTimeout(() => {
                        const backBtn = document.getElementById('backToEvents');
                        if (backBtn) {
                            backBtn.addEventListener('click', () => {
                                mainContent.classList.remove('event-selected');
                                mainContent.scrollTop = 0;
                                emptyState.style.display = 'flex';
                                
                                // Remove active class from all event items
                                document.querySelectorAll('.event-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                            });
                        }
                    }, 100);
                };
            }
            
            // When clicking an event in sidebar
            document.querySelectorAll('.event-item').forEach(item => {
                const originalClick = item.onclick;
                item.addEventListener('click', function(e) {
                    // Call original click handler if it exists
                    if (originalClick) originalClick.call(this, e);
                    
                    // Remove active class from all event items
                    document.querySelectorAll('.event-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                });
            });
            
            // Initial state - show empty state
            mainContent.classList.remove('event-selected');
            if (emptyState) emptyState.style.display = 'flex';
        }

        // Call setupMobileNavigation when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Add this line
            setupMobileNavigation();
        });
        
        // Also set up on window resize
        window.addEventListener('resize', setupMobileNavigation);
        // ============ END OF NEW CODE ============

    </script>
</body>
</html>
